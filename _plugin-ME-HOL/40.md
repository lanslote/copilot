---
title: 4. 포켓몬 플러그인 만들기
layout: default
nav_enabled: true
nav_order: 40
has_toc: true
has_children: true
---

# 포켓몬 플러그인 만들어서 배포하기
{: .no_toc }

<details open markdown="block">
  <summary>
    Table of contents
  </summary>
  {: .text-delta }
- TOC
{:toc}
</details>

---

이제 앞서 만든 목업 API와 연동하는 코파일럿 플러그인을 만들 차례 입니다. 기본적으로 팀즈 툴킷이 제공하는 템플릿으로 NPM 검색 플러그인을 만들고 그것의 코드를 포켓몬 API를 호출하여 동작하도록 변경하는 방식으로 진행하겠습니다.

---

## 1. 템플릿을 이용하여 프로젝트 만들기
팀즈 툴킷이 제공하는 메세지 익스텐션 템플릿으로 프로젝트를 생성합니다. 앞서 진행한 최초 프로젝트 생성하여 테스트한 내용과 유사합니다.

VS Code를 새 창으로 엽니다. 왼쪽 메뉴에서 팀즈 툴킷 아이콘을 클릭합니다. 패널에서 **Create a new App** 을 클릭합니다. 생성할 수 있는 팀즈 앱 종류 중에서 **Message Extension**을 선택하여 클릭합니다. <br/>
![*******](../assets/40/40-01.png)

**Custom Search Results** 를 선택합니다. <br/>
![*******](../assets/40/40-02.png)

**Start with a Bot**을 선택합니다. <br/>
![*******](../assets/40/40-03.png)

**JavaScript** 를 선택합니다. <br/>
![*******](../assets/40/40-04.png)

**Default folder**를 선택합니다. <br/>
![*******](../assets/40/40-05.png)

플러그인 프로젝트의 이름을 정해 줍니다. <br/>
![*******](../assets/40/40-06.png)

프로젝트가 만들어지고 새 창으로 열립니다. <br/>
![*******](../assets/40/40-07.png)


---

## 2. 포켓몬 플러그인으로 코드 수정
플러그인의 코드를 수정하겠습니다.
> 구체적으로는 세 개의 파일 내용을 수정할 것입니다.
> - searchApp.js
> - pokemonCard.js
> - manifest.json

### 2-1. searchApp.js 수정
searchApp.js 는 사용자가 입력한 파라미터를 전달받아 데이터 소스 (포켓몬 API)에서 검색결과를 받아 코파일럿에게 반환하는 역할을 합니다. searchApp.js 는 src 폴더 아래에 있습니다.

searchApp.js 파일을 열어 **class SearchApp extends TeamsActivityHandler** 코드를 찾습니다. 코드의 **7번 라인**입니다. <br/>
![*******](../assets/40/40-08.png)

이 위치 바로 위에 아래의 코드 세줄을 삽입합니다.

```js
const pokemonCard = require("./adaptiveCards/pokemonCard.json");
const { Console } = require("console");
const { type } = require("os");
```

그러면 아래와 같이 될 것입니다. <br/>
![*******](../assets/40/40-09.png)

---

그 바로 아래에 아래의 코드 (두개의 함수) 를 삽입니다.

```js
function search(nameKey, myArray, returnVal){
  for (let i=0; i < myArray.length; i++) {
      if (myArray[i].name === nameKey) {
        if (returnVal){
          return myArray[i].value;
        }
        else{
          return myArray[i];
        }
      }
  }
}

function timestamp(){
  var today = new Date();
  today.setHours(today.getHours() + 9);
  return today.toISOString().replace('T', ' ').substring(0, 19);
}
```

그러면 아래와 같이 될 것입니다. <br/>
![*******](../assets/40/40-10.png)

---

코드에서 SearchApp 클래스를 찾아 선택합니다. 이 클래스를 통째로 지우고 교체할 것입니다. <br/>
![*******](../assets/40/40-11.png)

SearchApp 클래스를 아래의 코드로 교체합니다.

```js
class SearchApp extends TeamsActivityHandler {
  constructor() {
    super();
  }

  // Message extension Code
  // Search.
  async handleTeamsMessagingExtensionQuery(context, query) {
    //const searchQuery = query.parameters[0].value;
    console.log(search('poke_name', query.parameters, false));
    console.log(search('poke_type', query.parameters, false));
    console.log(timestamp());
    
    let poke_name = "", poke_type = "";
    if (search('poke_name', query.parameters, false)){
      poke_name = search('poke_name', query.parameters, false).value;
    }
    if (search('poke_type', query.parameters, false)){
      poke_type = search('poke_type', query.parameters, false).value;
    }

    //주소 변경 필요
    const response = await axios.get(
      `https://**************.azurewebsites.net/api/**********?${querystring.stringify({
        name: poke_name,
        type: poke_type,
      })}`
    );

    const attachments = [];
    response.data.pokemons.forEach((pokemon) => {
      const evols = [];
      if (pokemon.prev_evolution){
        pokemon.prev_evolution.forEach((evol) => {
          evols.push(evol);
        })
      }
      evols.push({
        "num":pokemon.num,
        "name":pokemon.name
      });
      if (pokemon.next_evolution){
        pokemon.next_evolution.forEach((evol) => {
          evols.push(evol);
        })
      }

      let temp_evolimg1 = "", temp_evolimg2 = "", temp_evolimg3 = "", temp_evolimg4 = ""
      let temp_evolname1 = "", temp_evolname2 = "", temp_evolname3 = "", temp_evolname4 = "";
      if (evols[0]) {
        temp_evolimg1 = "http://www.serebii.net/pokemongo/pokemon/" + evols[0].num + ".png";
        temp_evolname1 = evols[0].name;
      }
      if (evols[1]) {
        temp_evolimg2 = "http://www.serebii.net/pokemongo/pokemon/" + evols[1].num + ".png";
        temp_evolname2 = evols[1].name;
      }
      if (evols[2]) {
        temp_evolimg3 = "http://www.serebii.net/pokemongo/pokemon/" + evols[2].num + ".png";
        temp_evolname3 = evols[2].name;
      }
      if (evols[3]) {
        temp_evolimg4 = "http://www.serebii.net/pokemongo/pokemon/" + evols[3].num + ".png";
        temp_evolname4 = evols[3].name;
      }

      const template = new ACData.Template(pokemonCard);
      const card = template.expand({
        $root: {
          num: pokemon.num,
          name: pokemon.name,
          img: pokemon.img,
          type: pokemon.type,
          height: pokemon.height,
          weight: pokemon.weight,
          candy: pokemon.candy,
          weaknesses: pokemon.weaknesses.join(", "),
          evolimg1: temp_evolimg1,
          evolname1: temp_evolname1,
          evolimg2: temp_evolimg2,
          evolname2: temp_evolname2,
          evolimg3: temp_evolimg3,
          evolname3: temp_evolname3,
          evolimg4: temp_evolimg4,
          evolname4: temp_evolname4,
        },
      });
      const preview = CardFactory.heroCard(pokemon.name);
      const attachment = { ...CardFactory.adaptiveCard(card), preview };
      attachments.push(attachment);
    });

    return {
      composeExtension: {
        type: "result",
        attachmentLayout: "list",
        attachments: attachments,
      },
    };
  }
}
```

{: .important }
> 코드상의 24행에 위치한 포켓몬 데이터 API 의 주소를 나의 API URL로 교체하셔야 합니다.
> https://**************.azurewebsites.net/api/**********


### 2-2. pokemonCard.json 추가
이제 커스텀 메세지 카드 즉, 어댑티브 카드를 만들어 줄 차례 입니다.

src 폴더 아래에 있는 **adaptiveCards** 폴더를 선택한 채로 **파일추가** 버튼을 클릭합니다. 파일 이름은 **pokemonCard.json** 으로 입력해 주십시오. <br/>
![*******](../assets/40/40-12.png)

json 파일의 내용을 채워줍니다. 채울 코드 내용은 여기 (https://lanslote.github.io/copilot/plugin-ME-HOL/42/) 에 있습니다. <br/>
![*******](../assets/40/40-13.png)


### 2-3. 플러그인 아이콘 파일 준비
플러그인이 적절한 아이콘을 가지게 되면, 사용자 경험에 많은 도움이 됩니다. 다음 경로에서 두개의 이미지 파일을 다운로드 하여 프로젝트의 appPakage 폴더에 추가해 주십시오. 
- https://lanslote.github.io/copilot/plugin-ME-HOL/assets/40/color_ball.png
- https://lanslote.github.io/copilot/plugin-ME-HOL/assets/40/outline_ball.png <br/>
![*******](../assets/40/40-14.png)


### 2-3. manifest.json 수정
이제 매니페스트 파일을 수정할 차례 입니다. 매니페스트 파일은 앱의 중요정보를 가지고 있는 파일로 앱 배포의 핵심이라고 할 수 있습니다.

```json
"icons": {
  "color": "color_ball.png",
  "outline": "outline_ball.png"
},
```


```json
"name": {
  "short": "PokemonME${% raw %}{{APP_NAME_SUFFIX}}{% endraw %}",
  "full": "포켓몬 정보 조회 코파일럿 플러그인"
},
```

```json
"description": {
  "short": "포켓몬 정보를 이름과 타입으로 검색합니다.",
  "full": "포켓몬 정보를 이름과 타입으로 검색합니다. \n예) 꼬부기라는 이름의 포켓몬 정보를 찾아줘 \n예) 전기 타입의 포켓몬 정보를 찾아줘"
},
```

```json
"commands": [
  {
    "id": "nameSearch",
    "context": [
        "compose",
        "commandBox"
    ],
    "description": "이름으로 포켓몬을 검색",
    "title": "포켓몬 이름",
    "type": "query",
    "semanticDescription": "이 커맨드는 제공된 이름으로 찾은 포켓몬의 정보를 받습니다.",
    "parameters": [
        {
            "name": "poke_name",
            "title": "포켓몬 이름",
            "description": "검색할 포켓몬의 이름",
            "inputType": "text",
            "semanticDescription": "이 매개변수는 검색할 포켓몬을 식별하기 위한 것입니다. 사용자는 찾고자 하는 포켓몬의 이름을 이 매개변수의 값으로 제공해야 합니다."
        }
    ]
  },
  {
    "id": "typeSearch",
    "context": [
        "compose",
        "commandBox"
    ],
    "description": "타입으로 포켓몬을 검색",
    "title": "포켓몬 타입",
    "type": "query",
    "semanticDescription": "이 커맨드는 제공된 타입으로 찾은 포켓몬의 정보를 받습니다. 예를 들어 '전기 타입인 포켓몬 찾아줘'라고 사용자가 말하면 검색을 원하는 타입이 '전기'입니다",
    "parameters": [
        {
            "name": "poke_type",
            "title": "포켓몬 타입",
            "description": "검색할 포켓몬의 타입",
            "inputType": "text",
            "semanticDescription": "이 매개변수는 검색할 포켓몬을 식별하기 위한 것입니다. 사용자는 찾고자 하는 포켓몬의 타입을 이 매개변수의 값으로 제공해야 합니다."
        }
    ]
  }
]
```

---

## 3. 포켓몬 플러그인 테스트
![*******](../assets/40/40-15.png)

![*******](../assets/40/40-16.png)

![*******](../assets/40/40-17.png)

![*******](../assets/40/40-18.png)

![*******](../assets/40/40-19.png)

![*******](../assets/40/40-20.png)

![*******](../assets/40/40-21.png)

![*******](../assets/40/40-22.png)

![*******](../assets/40/40-23.png)

![*******](../assets/40/40-24.png)

![*******](../assets/40/40-25.png)

![*******](../assets/40/40-26.png)

![*******](../assets/40/40-27.png)

![*******](../assets/40/40-28.png)



---

## 4. 포켓몬 플러그인을 클라우드에 배포

### 4-1. 팀즈 툴킷을 프리릴리즈 버전으로 전환
![*******](../assets/40/40-29.png)

### 4-2. 팀즈 툴킷의 Azure 구독 계정 로그인
![*******](../assets/40/40-30.png)

![*******](../assets/40/40-31.png)

![*******](../assets/40/40-32.png)

![*******](../assets/40/40-33.png)

![*******](../assets/40/40-34.png)



### 4-2. 플러그인을 클라우드에 프로비전
![*******](../assets/40/40-35.png)

![*******](../assets/40/40-36.png)

![*******](../assets/40/40-37.png)

![*******](../assets/40/40-38.png)

![*******](../assets/40/40-39.png)


### 4-3. 플러그인을 클라우드에 배포
![*******](../assets/40/40-40.png)

![*******](../assets/40/40-41.png)


### 4-4. 플러그인 테스트
![*******](../assets/40/40-42.png)

![*******](../assets/40/40-43.png)

![*******](../assets/40/40-44.png)

---

## 5. [중요] 배포된 플러그인 앱 비용관리

![*******](../assets/40/40-45.png)

![*******](../assets/40/40-46.png)

![*******](../assets/40/40-47.png)

![*******](../assets/40/40-48.png)

![*******](../assets/40/40-49.png)

![*******](../assets/40/40-50.png)

![*******](../assets/40/40-51.png)

![*******](../assets/40/40-52.png)

![*******](../assets/40/40-53.png)

![*******](../assets/40/40-54.png)

